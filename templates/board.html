<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Team Task Dashboard</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
    }

    .app {
      background: #ffffff;
      width: 100%;
      max-width: 1000px;
      min-height: 500px;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      display: flex;
      overflow: hidden;
    }

    .sidebar {
      width: 30%;
      border-right: 1px solid #eee;
      background: #fafafa;
      padding: 16px;
    }

    .main {
      width: 70%;
      padding: 20px;
    }

    h1 {
      margin: 0 0 12px;
      font-size: 22px;
      text-align: center;
      color: #333;
    }

    h2 {
      margin: 0 0 8px;
      font-size: 18px;
      color: #333;
    }

    .subtitle {
      font-size: 13px;
      color: #777;
      text-align: center;
      margin-bottom: 16px;
    }

    .member-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .member-item {
      padding: 10px 12px;
      margin-bottom: 8px;
      border-radius: 8px;
      cursor: pointer;
      border: 1px solid transparent;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .member-item span.name {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    .member-item span.role {
      font-size: 12px;
      color: #777;
    }

    .member-item:hover {
      background: #e8f5e9;
      border-color: #4caf50;
    }

    .member-item.active {
      background: #c8e6c9;
      border-color: #2e7d32;
    }

    .main-header {
      margin-bottom: 16px;
    }

    .main-header .name {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }

    .main-header .role {
      font-size: 13px;
      color: #777;
    }

    .progress-container {
      margin: 12px 0 16px;
    }

    .progress-label {
      font-size: 13px;
      margin-bottom: 4px;
      color: #555;
      display: flex;
      justify-content: space-between;
    }

    .progress-bar {
      width: 100%;
      height: 12px;
      background: #eee;
      border-radius: 999px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: #4caf50;
      transition: width 0.2s ease-out;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td {
      padding: 8px 6px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }

    th {
      background: #f5f5f5;
      font-weight: 600;
    }

    tr:last-child td {
      border-bottom: none;
    }

    select {
      padding: 4px;
      font-size: 12px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .status-done {
      color: #2e7d32;
      font-weight: 600;
    }

    .status-progress {
      color: #f57c00;
      font-weight: 600;
    }

    .status-todo {
      color: #757575;
      font-weight: 600;
    }

    .empty-state {
      font-size: 13px;
      color: #777;
      text-align: center;
      margin-top: 40px;
    }

    @media (max-width: 768px) {
      .app {
        flex-direction: column;
      }
      .sidebar, .main {
        width: 100%;
      }
      .sidebar {
        border-right: none;
        border-bottom: 1px solid #eee;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="sidebar">
      <h1>Team Tasks</h1>
      <div class="subtitle">Select a member to view their tasks</div>
      <ul class="member-list" id="memberList"></ul>
    </div>

    <div class="main">
      <div id="mainContent">
        <div class="empty-state">
          ðŸ‘‹ Select a team member from the left to see their tasks.
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG: match your Django Task model ======
    const API_BASE = "/api/tasks/";  // DRF router: /api/tasks/
    
    // These IDs must match Task.assignee values in your model
    const TEAM_MEMBERS = [
      { id: "vinay",    name: "Vinay Kumar V",     role: "Admin Dashboard & Analytics" },
      { id: "yashwanth",name: "Yashwanth H V",    role: "Backend & Database Engineer" },
      { id: "shashana", name: "Shashanka S",      role: "Frontend & UI Developer" },
      { id: "lakshman", name: "Lakshmana M R",    role: "Recommendation & Deployment" },
    ];

    // Map between API status values and UI labels
    const STATUS_API_TO_LABEL = {
      "todo": "To-Do",
      "in_progress": "In Progress",
      "done": "Done",
    };

    const STATUS_LABEL_TO_API = {
      "To-Do": "todo",
      "In Progress": "in_progress",
      "Done": "done",
    };

    // ====== Local cache & DOM refs ======
    let allTasks = [];  // full list from API
    const memberListEl = document.getElementById("memberList");
    const mainContentEl = document.getElementById("mainContent");

    // ====== CSRF helper for Django PATCH/POST ======
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // ====== LocalStorage helpers (C) ======
    function saveTasksToLocal() {
      try {
        localStorage.setItem("tasks", JSON.stringify(allTasks));
      } catch (e) {
        console.warn("Could not write tasks to localStorage", e);
      }
    }

    function loadTasksFromLocal() {
      try {
        const raw = localStorage.getItem("tasks");
        return raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.warn("Could not read tasks from localStorage", e);
        return [];
      }
    }

    // ====== API calls (A) ======
    async function fetchTasksFromAPI() {
      try {
        const response = await fetch(API_BASE);
        if (!response.ok) throw new Error("API error " + response.status);
        const data = await response.json();
        allTasks = data;
        saveTasksToLocal();
      } catch (err) {
        console.error("API failed, falling back to localStorage:", err);
        allTasks = loadTasksFromLocal();
      }
    }

    async function updateTaskStatusOnServer(taskId, newStatusApi) {
      try {
        await fetch(`${API_BASE}${taskId}/`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify({ status: newStatusApi }),
        });
      } catch (err) {
        console.error("Failed to update task on server", err);
      }
    }

    // ====== UI helpers ======
    function computeProgress(tasks) {
      if (!tasks.length) return 0;
      const doneCount = tasks.filter(t => t.status === "Done").length;
      return Math.round((doneCount / tasks.length) * 100);
    }

    function statusClass(status) {
      if (status === "Done") return "status-done";
      if (status === "In Progress") return "status-progress";
      return "status-todo";
    }

    function getTasksForMember(memberId) {
      // Filter tasks from the global list and map to UI format
      const tasks = allTasks
        .filter(t => t.assignee === memberId)
        .map(t => ({
          id: t.id,
          title: t.title,
          status: STATUS_API_TO_LABEL[t.status] || "To-Do",
          due: t.due_date || "",
        }));

      return tasks;
    }

    // ====== Render functions ======
    function renderMemberList() {
      memberListEl.innerHTML = "";
      TEAM_MEMBERS.forEach(member => {
        const li = document.createElement("li");
        li.className = "member-item";
        li.dataset.id = member.id;

        const nameSpan = document.createElement("span");
        nameSpan.className = "name";
        nameSpan.textContent = member.name;

        const roleSpan = document.createElement("span");
        roleSpan.className = "role";
        roleSpan.textContent = member.role;

        li.appendChild(nameSpan);
        li.appendChild(roleSpan);

        li.addEventListener("click", () => {
          document.querySelectorAll(".member-item").forEach(item => {
            item.classList.remove("active");
          });
          li.classList.add("active");
          renderMemberDetails(member.id);
        });

        memberListEl.appendChild(li);
      });
    }

    function renderMemberDetails(memberId) {
      const member = TEAM_MEMBERS.find(m => m.id === memberId);
      if (!member) return;

      const memberTasks = getTasksForMember(memberId);
      const progress = computeProgress(memberTasks);

      mainContentEl.innerHTML = "";

      // Header
      const headerDiv = document.createElement("div");
      headerDiv.className = "main-header";

      const nameEl = document.createElement("div");
      nameEl.className = "name";
      nameEl.textContent = member.name;

      const roleEl = document.createElement("div");
      roleEl.className = "role";
      roleEl.textContent = member.role;

      headerDiv.appendChild(nameEl);
      headerDiv.appendChild(roleEl);

      // Progress
      const progressContainer = document.createElement("div");
      progressContainer.className = "progress-container";

      const progressLabel = document.createElement("div");
      progressLabel.className = "progress-label";
      progressLabel.innerHTML = `<span>Task Progress</span><span>${progress}% complete</span>`;

      const progressBar = document.createElement("div");
      progressBar.className = "progress-bar";

      const progressFill = document.createElement("div");
      progressFill.className = "progress-fill";
      progressFill.style.width = progress + "%";

      progressBar.appendChild(progressFill);
      progressContainer.appendChild(progressLabel);
      progressContainer.appendChild(progressBar);

      // Table
      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");

      ["Task", "Status", "End Date"].forEach(text => {
        const th = document.createElement("th");
        th.textContent = text;
        headerRow.appendChild(th);
      });

      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      memberTasks.forEach(task => {
        const tr = document.createElement("tr");

        const titleTd = document.createElement("td");
        titleTd.textContent = task.title;

        const statusTd = document.createElement("td");
        const select = document.createElement("select");

        ["To-Do", "In Progress", "Done"].forEach(optText => {
          const opt = document.createElement("option");
          opt.value = optText;
          opt.textContent = optText;
          if (optText === task.status) opt.selected = true;
          select.appendChild(opt);
        });

        select.className = statusClass(task.status);

        select.addEventListener("change", async () => {
          // Update local UI status
          task.status = select.value;
          select.className = statusClass(task.status);

          const newProgress = computeProgress(memberTasks);
          progressFill.style.width = newProgress + "%";
          progressLabel.innerHTML = `<span>Task Progress</span><span>${newProgress}% complete</span>`;

          // Update global cache + server
          const apiStatus = STATUS_LABEL_TO_API[task.status] || "todo";
          const globalTask = allTasks.find(t => t.id === task.id);
          if (globalTask) {
            globalTask.status = apiStatus;
            saveTasksToLocal();
          }
          await updateTaskStatusOnServer(task.id, apiStatus);
        });

        statusTd.appendChild(select);

        const dueTd = document.createElement("td");
        dueTd.textContent = task.due || "-";

        tr.appendChild(titleTd);
        tr.appendChild(statusTd);
        tr.appendChild(dueTd);

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);

      mainContentEl.appendChild(headerDiv);
      mainContentEl.appendChild(progressContainer);
      mainContentEl.appendChild(table);

      if (!memberTasks.length) {
        const empty = document.createElement("div");
        empty.className = "empty-state";
        empty.textContent = "No tasks found for this member. Add some in Django admin.";
        mainContentEl.appendChild(empty);
      }
    }

    // ====== Init ======
    (async function init() {
      renderMemberList();
      await fetchTasksFromAPI();
      // Optionally auto-select first member:
      const first = TEAM_MEMBERS[0];
      if (first) {
        const firstLi = document.querySelector(`.member-item[data-id="${first.id}"]`);
        if (firstLi) {
          firstLi.classList.add("active");
        }
        renderMemberDetails(first.id);
      }
    })();
  </script>
</body>
</html>
